<div id="temporal-gap-root" class="audit-wrapper">
    <div class="p-6">
        <div class="flex items-center gap-3 mb-2">
            <h1 class="text-3xl font-bold text-purple-400">ğŸ“‰ IID Gap Analysis</h1>
            <span id="gapDataSource" class="text-[11px] px-2 py-1 rounded border border-purple-700 text-purple-300 bg-purple-900/30">Source: â€”</span>
        </div>
        <h2 class="text-gray-400 mb-8">ì‹¤ì œ ë°ì´í„° vs ë…ë¦½ ì‹œí–‰(Fair World) ë¹„êµ: "ë³´ì • ë¡œì§"ì˜ ì‹¤ì²´ë¥¼ í†µê³„ë¡œ ì‹œê°í™”</h2>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-gray-800 border border-gray-700 rounded-xl p-6">
                <h4 class="text-purple-400 text-sm uppercase mb-2">ìê¸°ìƒê´€ì„± (Autocorrelation)</h4>
                <div class="text-3xl font-bold" id="gapAutocorr">--</div>
                <p class="text-gray-500 text-xs mt-2">ìŒìˆ˜ë©´ ë¦¬ë°¸ëŸ°ì‹±(ë³´ì •) ê°•ë ¥ ì˜ì‹¬. í–‰ìš´ ë’¤ì— ë¶ˆìš´ì´ ê°•ì œë¡œ ë”°ë¼ì˜¤ëŠ” ì •ë„.</p>
            </div>
            <div class="bg-gray-800 border border-gray-700 rounded-xl p-6">
                <h4 class="text-purple-400 text-sm uppercase mb-2">ê²°ê³¼ í‰íƒ„í™” (Variance)</h4>
                <div class="text-3xl font-bold" id="gapVariance">--</div>
                <p class="text-gray-500 text-xs mt-2">1.0ë³´ë‹¤ ë‚®ì„ìˆ˜ë¡ ì¸ìœ„ì ì¸ í‰íƒ„í™”(ê²°ê³¼ ê³ ì •) ì˜ì‹¬.</p>
            </div>
            <div class="bg-gray-800 border border-gray-700 rounded-xl p-6">
                <h4 class="text-purple-400 text-sm uppercase mb-2">ë¹„ëŒ€ì¹­ì„± (Skewness)</h4>
                <div class="text-3xl font-bold" id="gapSkew">--</div>
                <p class="text-gray-500 text-xs mt-2">ë°ì´í„°ì˜ ì¹˜ìš°ì¹¨ ì •ë„. 0ì—ì„œ ë©€ìˆ˜ë¡ í•œìª½ìœ¼ë¡œ ì ë¦° ë¶„í¬.</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <div class="bg-gray-800 border border-gray-700 rounded-xl p-6 h-[450px] lg:col-span-2 relative">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-gray-400 text-xs uppercase tracking-wider">Z-Score ì‹œê³„ì—´: ì‹¤ì œ ë°ì´í„°(Real) vs ë…ë¦½ ì‹œí–‰(Fair
                        World)</h4>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-500">ë¶„ì„ ëŒ€ìƒ:</span>
                        <select id="gapStarSelector"
                            class="bg-gray-700 border border-gray-600 text-purple-400 text-xs rounded px-2 py-1 outline-none focus:border-purple-500">
                            <!-- 12ì„±ë¶€í„° 25ì„±ê¹Œì§€ ì˜µì…˜ ì¶”ê°€ -->
                            <option value="12">12ì„±</option>
                            <option value="13">13ì„±</option>
                            <option value="14">14ì„±</option>
                            <option value="15">15ì„±</option>
                            <option value="16">16ì„±</option>
                            <option value="17" selected>17ì„±</option>
                            <option value="18">18ì„±</option>
                            <option value="19">19ì„±</option>
                            <option value="20">20ì„±</option>
                            <option value="21">21ì„±</option>
                            <option value="22">22ì„±</option>
                            <option value="23">23ì„±</option>
                            <option value="24">24ì„±</option>
                            <option value="25">25ì„±</option>
                        </select>
                    </div>
                </div>
                <div class="h-[360px]">
                    <canvas id="gapTimeSeriesChart"></canvas>
                </div>
            </div>
            <div class="bg-gray-800 border border-gray-700 rounded-xl p-6 h-[400px]">
                <h4 class="text-gray-400 text-xs mb-4">Z-Score ë¶„í¬ ë¹„êµ: ì‹¤ì œ vs IID</h4>
                <div class="h-[330px]">
                    <canvas id="gapDistChart"></canvas>
                </div>
            </div>
            <div class="bg-gray-800 border border-gray-700 rounded-xl p-6 h-[400px]">
                <h4 class="text-gray-400 text-xs mb-4">ë‹¨ê³„ë³„ ë¦¬ë°¸ëŸ°ì‹± ê°•ë„ (Autocorrelation by Star)</h4>
                <div class="h-[330px]">
                    <canvas id="gapStarChart"></canvas>
                </div>
            </div>
        </div>

        <div class="bg-gray-800 border border-gray-700 rounded-xl p-6 mb-8">
            <h4 class="text-gray-400 text-xs mb-4">ìš”ì•½: ì„±ë³„ í‘œë³¸ ìˆ˜ / ì‹œë„ ìˆ˜ / ìê¸°ìƒê´€ í‘œì¤€ì˜¤ì°¨</h4>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-xs">
                    <thead class="bg-gray-900 text-gray-400">
                        <tr>
                            <th class="p-2">STAR</th>
                            <th class="p-2 text-right">N</th>
                            <th class="p-2 text-right">n_mean</th>
                            <th class="p-2 text-right">n_med</th>
                            <th class="p-2 text-right">autocorr</th>
                            <th class="p-2 text-right">SE(1/âˆšN)</th>
                            <th class="p-2 text-right">z_mean</th>
                            <th class="p-2 text-right">z_std</th>
                        </tr>
                    </thead>
                    <tbody id="gapSummaryTable" class="text-gray-300"></tbody>
                </table>
            </div>
        </div>

        <div class="bg-purple-900 bg-opacity-20 border border-purple-800 rounded-xl p-6">
            <h3 class="text-purple-400 font-bold mb-2">ğŸ’¡ ë¶„ì„ ê°€ì´ë“œ</h3>
            <ul class="text-sm text-gray-300 space-y-2 list-disc pl-5">
                <li>ë³´ë¼ìƒ‰ ì‹¤ì„ (Real)ì´ ì´ˆë¡ìƒ‰ ì ì„ (IID)ë³´ë‹¤ ë” ë¹ˆë²ˆí•˜ê²Œ ë°˜ëŒ€ ë°©í–¥ìœ¼ë¡œ êº¾ì¸ë‹¤ë©´, ì‹œìŠ¤í…œì´ ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ë¥ ì„ ì¡°ì ˆí•˜ê³  ìˆë‹¤ëŠ” ì¦ê±°ì…ë‹ˆë‹¤.</li>
                <li>ì˜¤ë¥¸ìª½ í•˜ë‹¨ì˜ 'ìê¸°ìƒê´€ì„±' ê·¸ë˜í”„ì—ì„œ ë§‰ëŒ€ê°€ ì•„ë˜ë¡œ(ìŒìˆ˜) ê¸¸ìˆ˜ë¡, í•´ë‹¹ ì„±ê¸‰ì—ì„œì˜ ë³´ì • ê°œì…ì´ ë” ê°•ë ¥í•¨ì„ ì˜ë¯¸í•©ë‹ˆë‹¤.</li>
            </ul>
        </div>
    </div>
</div>

<script>
    // Inline IID Gap Analysis - bypasses module loading issues
    (function () {
        const gapCharts = { ts: null, dist: null, star: null };
        let gapData = null;

        async function fetchAndRender(star = 17) {
            console.log('[GapAnalysis-Inline] Fetching data for ' + star + '*');

            try {
                if (!gapData) {
                    const res = await fetch('/api/audit/temporal-gap');
                    if (!res.ok) throw new Error('HTTP ' + res.status);
                    gapData = await res.json();
                    console.log('[GapAnalysis-Inline] Data loaded:', Object.keys(gapData));
                }

                renderDataSource();
                renderSummaryTable();
                renderGapAnalysis(star);
            } catch (err) {
                console.error('[GapAnalysis-Inline] Error:', err);
                const el = document.getElementById('gapAutocorr');
                if (el) el.innerHTML = '<span style="color:#cf6679">Error</span>';
            }
        }

        function renderGapAnalysis(star) {
            const starData = gapData[star];
            if (!starData) {
                console.warn('[GapAnalysis-Inline] No data for star ' + star);
                return;
            }

            // Update Metrics
            const autocorr = document.getElementById('gapAutocorr');
            if (autocorr) {
                const val = starData.real.autocorr;
                autocorr.innerHTML = `<span style="color:${val < 0 ? '#cf6679' : '#03dac6'}">${val.toFixed(2)}</span>`;
            }

            const variance = document.getElementById('gapVariance');
            if (variance) {
                const val = starData.real.variance;
                const color = val < 0.7 ? '#cf6679' : (val < 0.9 ? '#ffb74d' : '#03dac6');
                variance.innerHTML = `<span style="color:${color}">${val.toFixed(2)}</span>`;
            }

            const skew = document.getElementById('gapSkew');
            if (skew) {
                const val = starData.real.skew;
                skew.innerHTML = `<span style="color:${Math.abs(val) > 0.5 ? '#ffb74d' : '#03dac6'}">${val.toFixed(2)}</span>`;
            }

            // Render Time Series Chart
            const ctxTS = document.getElementById('gapTimeSeriesChart');
            if (ctxTS) {
                if (gapCharts.ts) gapCharts.ts.destroy();

                const labels = starData.real.hourly.map(d => {
                    // Use window_end if available, else timestamp
                    const ts = d.window_end || d.timestamp;
                    // Format: MM/DD HH:mm
                    const m = ts.slice(5, 7);
                    const day = ts.slice(8, 10);
                    const h = ts.slice(11, 16);
                    return `${m}/${day} ${h}`;
                });
                gapCharts.ts = new Chart(ctxTS.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Real Z-Score',
                                data: starData.real.z_scores,
                                borderColor: '#bb86fc',
                                backgroundColor: 'rgba(187, 134, 252, 0.1)',
                                fill: false,
                                tension: 0.1,
                                borderWidth: 2
                            },
                            {
                                label: 'IID Z-Score',
                                data: starData.iid.z_scores,
                                borderColor: '#03dac6',
                                borderDash: [5, 5],
                                fill: false,
                                tension: 0.1,
                                borderWidth: 1.5
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                title: { display: true, text: 'Z-Score', color: '#888' },
                                grid: { color: 'rgba(255,255,255,0.05)' },
                                ticks: { color: '#666' }
                            },
                            x: { ticks: { color: '#666' } }
                        },
                        plugins: { legend: { position: 'bottom', labels: { color: '#888' } } }
                    }
                });
            }

            // Render Distribution Chart
            const ctxDist = document.getElementById('gapDistChart');
            if (ctxDist) {
                if (gapCharts.dist) gapCharts.dist.destroy();

                const bins = [-3, -2, -1, 0, 1, 2, 3];
                const getCounts = (zScores) => bins.slice(0, -1).map((b, i) =>
                    zScores.filter(z => z >= b && z < bins[i + 1]).length
                );

                gapCharts.dist = new Chart(ctxDist.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['-3~-2', '-2~-1', '-1~0', '0~1', '1~2', '2~3'],
                        datasets: [
                            { label: 'Real', data: getCounts(starData.real.z_scores), backgroundColor: 'rgba(187, 134, 252, 0.5)' },
                            { label: 'IID', data: getCounts(starData.iid.z_scores), backgroundColor: 'rgba(3, 218, 198, 0.5)' }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { labels: { color: '#888' } } },
                        scales: {
                            x: { ticks: { color: '#666' } },
                            y: { ticks: { color: '#666' } }
                        }
                    }
                });
            }

            // Render Star Comparison Chart
            const ctxStar = document.getElementById('gapStarChart');
            if (ctxStar) {
                if (gapCharts.star) gapCharts.star.destroy();

                const stars = Object.keys(gapData)
                    .filter(k => Number.isFinite(Number(k)))
                    .sort((a, b) => Number(a) - Number(b));
                gapCharts.star = new Chart(ctxStar.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: stars.map(s => s + 'â˜…'),
                        datasets: [{
                            label: 'Autocorrelation',
                            data: stars.map(s => gapData[s].real.autocorr),
                            backgroundColor: stars.map(s => gapData[s].real.autocorr < -0.2 ? '#cf6679' : '#bb86fc')
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                title: { display: true, text: 'Correlation', color: '#888' },
                                min: -0.6,
                                max: 0.6,
                                ticks: { color: '#666' }
                            },
                            x: { ticks: { color: '#666' } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            console.log('[GapAnalysis-Inline] Rendering complete for ' + star + '*');
        }

        function renderSummaryTable() {
            const tbody = document.getElementById('gapSummaryTable');
            if (!tbody || !gapData) return;
            const stars = Object.keys(gapData)
                .filter(k => Number.isFinite(Number(k)))
                .map(Number)
                .sort((a, b) => a - b);

            tbody.innerHTML = '';
            for (const star of stars) {
                const row = gapData[star];
                if (!row || !row.summary) continue;
                const s = row.summary;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-2">${star}ì„±</td>
                    <td class="p-2 text-right">${s.n_obs ?? '-'}</td>
                    <td class="p-2 text-right">${(s.n_mean ?? 0).toFixed(1)}</td>
                    <td class="p-2 text-right">${(s.n_median ?? 0).toFixed(1)}</td>
                    <td class="p-2 text-right">${(row.real?.autocorr ?? 0).toFixed(3)}</td>
                    <td class="p-2 text-right">${(s.se_autocorr ?? 0).toFixed(3)}</td>
                    <td class="p-2 text-right">${(s.z_mean ?? 0).toFixed(2)}</td>
                    <td class="p-2 text-right">${(s.z_std ?? 0).toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            }
        }

        function renderDataSource() {
            const el = document.getElementById('gapDataSource');
            if (!el || !gapData) return;
            const meta = gapData._meta;
            if (!meta || !meta.source) {
                el.textContent = 'Source: â€”';
                return;
            }
            const src = meta.source;
            if (src === 'relabel') {
                el.textContent = `Source: relabel (${meta.sessions_relabel || 0}/${meta.sessions_total || 0})`;
            } else if (src === 'original') {
                el.textContent = `Source: original (${meta.sessions_original || 0}/${meta.sessions_total || 0})`;
            } else if (src === 'mixed') {
                el.textContent = `Source: mixed (${meta.sessions_relabel || 0} relabel / ${meta.sessions_original || 0} original)`;
            } else {
                el.textContent = `Source: ${src}`;
            }
        }

        // Expose globally
        window.gapAnalysisInline = { fetch: fetchAndRender };

        // Handle Selector Change
        const selector = document.getElementById('gapStarSelector');
        if (selector) {
            selector.addEventListener('change', (e) => {
                fetchAndRender(parseInt(e.target.value));
            });
        }

        // Auto-fetch if this tab is visible
        if (document.getElementById('tab-temporalGap') &&
            !document.getElementById('tab-temporalGap').classList.contains('hidden')) {
            fetchAndRender(17);
        }
    })();
</script>
