<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”¬ Statistical Audit Dashboard - ë…ë¦½ ì‹œí–‰ ê²€ì¦ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        :root {
            --bg: #0a0a0a;
            --card: #141414;
            --text: #e0e0e0;
            --accent: #bb86fc;
            --danger: #cf6679;
            --warning: #ffb74d;
            --success: #03dac6;
            --border: #222;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', sans-serif;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        h1 {
            color: var(--accent);
            margin-bottom: 5px;
        }

        h2 {
            color: #888;
            font-size: 1em;
            margin-bottom: 25px;
            font-weight: normal;
        }

        h3 {
            color: var(--accent);
            margin: 25px 0 15px;
            font-size: 1.1em;
        }

        /* Summary Layer */
        .summary-grid {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .gauge-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
        }

        .gauge-title {
            color: #666;
            font-size: 0.85em;
            margin-bottom: 8px;
        }

        .gauge-value {
            font-size: 3.5em;
            font-weight: bold;
        }

        .gauge-label {
            font-size: 0.8em;
            color: #888;
            margin-top: 12px;
        }

        .gauge-bar {
            height: 8px;
            background: #222;
            border-radius: 4px;
            margin-top: 15px;
            overflow: hidden;
        }

        .gauge-fill {
            height: 100%;
            border-radius: 4px;
            transition: all 0.5s;
        }

        .smoking-gun {
            background: linear-gradient(135deg, #1a1a1a, #261a1a);
            border: 1px solid #332222;
            border-radius: 12px;
            padding: 20px;
        }

        .smoking-gun h4 {
            color: var(--danger);
            margin-bottom: 15px;
        }

        .gun-item {
            background: rgba(207, 102, 121, 0.1);
            border-left: 3px solid var(--danger);
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 0 8px 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .gun-item .star {
            font-weight: bold;
        }

        .gun-item .stats {
            font-size: 0.8em;
            color: #888;
        }

        .gun-item .verdict {
            color: var(--danger);
            font-size: 0.75em;
            background: rgba(207, 102, 121, 0.2);
            padding: 2px 8px;
            border-radius: 4px;
        }

        /* Controls */
        .controls {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 30px;
            border: 1px solid var(--border);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group.events {
            flex: 1;
        }

        .events .checkbox-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px 20px;
        }

        .controls-right {
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-width: 180px;
        }

        label {
            font-size: 0.75em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select,
        input[type="number"] {
            background: #1a1a1a;
            border: 1px solid #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
        }

        .checkbox-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .checkbox-list label {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.8em;
            cursor: pointer;
            text-transform: none;
        }

        button {
            background: var(--accent);
            color: black;
            border: none;
            padding: 10px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        button:hover {
            opacity: 0.9;
        }

        /* Audit Cards */
        .audit-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }

        .audit-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }

        .audit-card h4 {
            color: var(--accent);
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .audit-card .metric {
            font-size: 2em;
            font-weight: bold;
        }

        .audit-card .desc {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
        }

        /* Table */
        .data-grid {
            width: 100%;
            border-collapse: collapse;
            background: var(--card);
            border-radius: 12px;
            overflow: hidden;
            font-size: 0.9em;
        }

        th,
        td {
            padding: 10px 12px;
            text-align: right;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: #1a1a1a;
            color: #666;
            font-size: 0.8em;
            cursor: pointer;
            user-select: none;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        th:hover {
            background: #222;
        }

        th.sorted-asc::after {
            content: ' â–²';
        }

        th.sorted-desc::after {
            content: ' â–¼';
        }

        td:first-child,
        th:first-child {
            text-align: left;
        }

        .row-critical {
            background: rgba(207, 102, 121, 0.15) !important;
        }

        .row-managed {
            background: rgba(207, 102, 121, 0.08) !important;
        }

        .badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75em;
        }

        .badge-on {
            background: #1b5e20;
        }

        .badge-off {
            background: #424242;
        }

        .badge-danger {
            background: var(--danger);
            color: white;
        }

        .badge-warning {
            background: var(--warning);
            color: black;
        }

        .tooltip {
            cursor: help;
            border-bottom: 1px dotted #555;
        }

        .tooltip:hover::after {
            content: attr(data-tip);
            position: absolute;
            background: #333;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.75em;
            white-space: nowrap;
            z-index: 100;
            transform: translateY(-100%);
            margin-top: -5px;
        }

        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            height: 380px;
        }

        .chart-card.full {
            grid-column: span 2;
            height: 450px;
        }

        .chart-title {
            color: #888;
            font-size: 0.85em;
            margin-bottom: 10px;
        }

        /* Heatmap */
        .heatmap-container {
            overflow-x: auto;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        /* Heatmap */
        .heatmap-container {
            overflow-x: auto;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .heatmap-table {
            border-collapse: collapse;
            font-size: 0.8em;
        }

        .heatmap-table th,
        .heatmap-table td {
            padding: 0;
            border: none;
            text-align: center;
        }

        .heatmap-cell {
            width: 50px;
            height: 35px;
            display: flex;
            /* Flex is okay if inside the cell, but let's try to apply it to a div inside or just use table props */
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            color: white;
            border-radius: 4px;
            margin: 2px;
            /* Gap simulation */
            font-weight: bold;
        }

        .heatmap-label {
            font-size: 0.85em;
            color: #888;
            padding: 5px;
            text-align: right;
            padding-right: 10px;
            white-space: nowrap;
        }

        .heatmap-header {
            font-size: 0.8em;
            color: #aaa;
            padding-bottom: 5px;
            text-align: center;
            white-space: nowrap;
        }

        /* Hypothesis */
        .hypothesis-card {
            background: linear-gradient(135deg, #1a1a2e, #1a2a1a);
            border: 1px solid #224422;
            border-radius: 12px;
            padding: 25px;
            margin-top: 25px;
        }

        .hypothesis-result {
            font-size: 1.1em;
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        /* Event Analysis Grid */
        .event-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .deception-card {
            background: linear-gradient(135deg, #2c0e0e, #1a0a0a);
            border: 1px solid #442222;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .deception-value {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--danger);
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .comparison-table td {
            padding: 8px;
            border-bottom: 1px solid #333;
        }

        .comparison-table .label {
            color: #888;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }

        .tab-btn {
            background: transparent;
            color: #888;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .tab-btn.active {
            background: rgba(187, 134, 252, 0.1);
            color: var(--accent);
            border-color: var(--accent);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Season Cards */
        .season-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .season-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 25px;
            position: relative;
            overflow: hidden;
        }

        .season-card.loan {
            border-left: 5px solid var(--success);
        }

        .season-card.collection {
            border-left: 5px solid var(--danger);
        }

        .season-tag {
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
            display: block;
        }

        .loan .season-tag {
            color: var(--success);
        }

        .collection .season-tag {
            color: var(--danger);
        }

        .season-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .season-desc {
            font-size: 0.9em;
            color: #888;
        }

        .meso-value {
            color: var(--warning);
            font-size: 1.2em;
            font-weight: bold;
            margin: 10px 0;
        }

        /* Slider Styling */
        input[type="range"] {
            -webkit-appearance: none;
            height: 6px;
            background: #222;
            border-radius: 3px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(187, 134, 252, 0.4);
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ”¬ í™•ë¥  ë¬´ê²°ì„± ê°ì‚¬ ëŒ€ì‹œë³´ë“œ</h1>
        <h2>ëª©í‘œ: "ë„¥ìŠ¨ì´ í™•ë¥ ì„ ë§ì¶”ê¸° ìœ„í•´ ìœ ì €ì˜ ë¬´ì‘ìœ„ì„±ì„ ì–¼ë§ˆë‚˜ í›¼ì†í–ˆëŠ”ê°€"ë¥¼ ì¦ëª…</h2>

        <div class="tabs">
            <button class="tab-btn active" onclick="ui.switchTab('general')">ê¸°ë³¸ ë¶„ì„</button>
            <button class="tab-btn" onclick="ui.switchTab('seasonal')">ì‹œì¦Œë³„ ëŒ€ì¡° ëª¨ë“œ (Debt/Loan)</button>
        </div>

        <div id="generalSection" class="tab-content active">

            <!-- SUMMARY LAYER -->
            <div class="summary-grid">
                <div class="gauge-card">
                    <div class="gauge-title">ğŸ¯ ì‹œìŠ¤í…œ ë¬´ê²°ì„± ì ìˆ˜</div>
                    <div class="gauge-value" id="integrityScore">--</div>
                    <div class="gauge-label" id="integrityLabel">ë¶„ì„ ì¤‘...</div>
                    <div class="gauge-bar">
                        <div class="gauge-fill" id="integrityBar"></div>
                    </div>
                </div>
                <div class="smoking-gun">
                    <h4>ğŸš¨ SMOKING GUN: ê²°ì •ì  ì¡°ì‘ ì˜ì‹¬ êµ¬ê°„ TOP 3</h4>
                    <div id="smokingGunList"></div>
                    <p style="font-size:0.75em; color:#555; margin-top:10px;">* Nì´ í¬ë©´ì„œ |Z|â†’0 = ì¸ìœ„ì  ì •ë°€ ê´€ë¦¬ (ë…ë¦½ ì‹œí–‰ ë¶ˆê°€ëŠ¥)</p>
                </div>
            </div>

            <!-- 3ëŒ€ í•µì‹¬ ê²€ì¦ AUDIT CARDS -->
            <div class="audit-grid">
                <div class="audit-card">
                    <h4>â‘  ì •ë°€ë„ ê°ì‚¬ (Precision Audit)</h4>
                    <div class="metric" id="precisionMetric">--</div>
                    <div class="desc">N>100ë§Œ & |Z|<0.1ì¸ "ê´€ë¦¬í˜• í™•ë¥ " êµ¬ê°„ ìˆ˜</div>
                    </div>
                    <div class="audit-card">
                        <h4>â‘¡ ë³‘ëª© ê°ì‚¬ (Threshold Audit)</h4>
                        <div class="metric" id="thresholdMetric">--</div>
                        <div class="desc">ì„±ê³µ ì–µì œ(Z<-2) + íŒŒê´´ ì–µì œ(Z<-2) ë™ì‹œ ë°œìƒ êµ¬ê°„</div>
                        </div>
                        <div class="audit-card">
                            <h4>â‘¢ ì œë¡œì„¬ ê°ì‚¬ (Zero-sum Audit)</h4>
                            <div class="metric" id="zerosumMetric">--</div>
                            <div class="desc">ê¸°ê°„ë³„ Zì˜ í•©ì´ 0ìœ¼ë¡œ ìˆ˜ë ´í•˜ëŠ” ì •ë„</div>
                        </div>
                    </div>

                    <!-- EVENT ANALYSIS WIDGETS -->
                    <div class="event-grid">
                        <div class="deception-card">
                            <h4>ğŸ‘º ì´ë²¤íŠ¸ ê¸°ë§ ì§€ìˆ˜ (Event Deception Index)</h4>
                            <div class="deception-value" id="deceptionIndex">--</div>
                            <div class="desc" id="deceptionDesc">ë¶„ì„ ì¤‘...</div>
                            <div id="starGroupContainer" style="margin-top:20px; text-align:left;">
                                <!-- Star groups injected here -->
                            </div>
                        </div>
                        <div class="audit-card" style="display:flex; flex-direction:column;">
                            <h4>âš–ï¸ ì´ë²¤íŠ¸ë³„ ê¸°ë§ ìˆœìœ„ (Event Ranking)</h4>
                            <div style="flex:1; overflow-y:auto; max-height:300px;">
                                <table class="comparison-table" id="eventRankTable">
                                    <thead>
                                        <tr>
                                            <th>ì´ë²¤íŠ¸ ëª…ì¹­</th>
                                            <th>ê¸°ë§ ì§€ìˆ˜</th>
                                            <th>VAR ì–µì œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="eventRankBody">
                                        <tr>
                                            <td colspan="3">ë¡œë”© ì¤‘...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- CONTROLS -->
                    <div class="controls">
                        <div class="control-group events">
                            <label>ì´ë²¤íŠ¸ í•„í„°</label>
                            <div class="checkbox-list" id="eventCheckboxes"></div>
                        </div>
                        <div class="controls-right">
                            <div class="control-group">
                                <label>ì„±ê¸‰ ë²”ìœ„</label>
                                <div style="display:flex; gap:5px; align-items:center;">
                                    <input type="number" id="starMin" value="15" min="0" max="29" style="width:55px"> ~
                                    <input type="number" id="starMax" value="22" min="0" max="29" style="width:55px">
                                </div>
                            </div>
                            <div class="control-group">
                                <label>ìŠ¤íƒ€ìºì¹˜</label>
                                <select id="catchFilter" style="width:100%;">
                                    <option value="">ì „ì²´</option>
                                    <option value="ON">ON</option>
                                    <option value="OFF">OFF</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label>ìµœì†Œ N</label>
                                <input type="number" id="minSamples" value="100000" step="100000" style="width:120px">
                            </div>
                            <button onclick="filters.apply()">ë¶„ì„ ì‹¤í–‰</button>
                        </div>
                    </div>

                    <div class="charts-grid">
                        <div class="chart-card">
                            <div class="chart-title">â‘¡ ë³‘ëª© ë¶„ì„: ì„±ê³µ Z vs íŒŒê´´ Z (ê³ ì°©í™” íƒì§€)</div>
                            <canvas id="thresholdChart"></canvas>
                        </div>
                        <div class="chart-card">
                            <div class="chart-title">â‘¢ ì œë¡œì„¬ ë¶„ì„: ê¸°ê°„ë³„ ëˆ„ì  Z ë“œë¦¬í”„íŠ¸</div>
                            <canvas id="driftChart"></canvas>
                        </div>
                        <div class="chart-card full">
                            <div class="chart-title">ğŸ“… ì›”ë³„ ëˆ„ì  Z-Score í•©ê³„</div>
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>

                    <!-- HEATMAP -->
                    <h3>ğŸ“Š ì„±ê¸‰ Ã— ê¸°ê°„ Z-Score íˆíŠ¸ë§µ</h3>
                    <div class="heatmap-container">
                        <div id="heatmapArea">íˆíŠ¸ë§µ ë¡œë”© ì¤‘...</div>
                    </div>

                    <!-- TABLE -->
                    <h3>ğŸ“‹ ìƒì„¸ ë¶„ì„ í…Œì´ë¸” (í´ë¦­í•˜ì—¬ ì •ë ¬)</h3>
                    <table class="data-grid" id="statsTable">
                        <thead>
                            <tr>
                                <th data-key="star">ì„±ê¸‰</th>
                                <th data-key="catch">ìºì¹˜</th>
                                <th data-key="total_n">N</th>
                                <th data-key="abs_succ_z">|Z| ì„±ê³µ</th>
                                <th data-key="succ_var">VAR</th>
                                <th data-key="boom_z">Z íŒŒê´´</th>
                                <th data-key="precision">ì •ë°€ë„</th>
                                <th data-key="verdict">íŒì •</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>

                    <!-- MORE CHARTS -->
                    <div class="charts-grid" style="margin-top:25px;">
                        <div class="chart-card">
                            <div class="chart-title">â‘  ì •ë°€ë„ ë¶„ì„: N vs |Z| ì‚°ì ë„</div>
                            <canvas id="precisionChart"></canvas>
                        </div>
                        <div class="chart-card">
                            <div class="chart-title">Z-Score ë¶„í¬ íˆìŠ¤í† ê·¸ë¨</div>
                            <canvas id="histChart"></canvas>
                        </div>
                    </div>

                    <!-- HYPOTHESIS -->
                    <div class="hypothesis-card">
                        <h3>ğŸ§ª ê³µìœ  ë± ê°€ì„¤ ê²€ì¦ (Shared Deck Hypothesis)</h3>
                        <p style="color:#888; font-size:0.85em;">ë…ë¦½ ì‹œí–‰ì´ë¼ë©´ VAR Ratio â‰ˆ 1.0, ê³µìœ  ë±ì´ë¼ë©´ VAR Ratio << 1.0
                                (ê³¼ì†Œì‚°í¬)</p>
                                <div class="hypothesis-result" id="hypothesisResult">ë¶„ì„ ë²„íŠ¼ì„ ëˆŒëŸ¬ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.</div>
                    </div>
                </div>

                <div id="seasonalSection" class="tab-content">
                    <h3>ğŸ“Š ì‹œì¦Œë³„ ëŒ€ì¡° ë¶„ì„: [ì„±ìˆ˜ê¸° ëŒ€ì¶œ] vs [ë¹„ì„±ìˆ˜ê¸° ì¶”ì‹¬]</h3>
                    <p style="color:#888; margin-bottom:20px;">* íŠ¹ì • ê¸°ê°„ ë™ì•ˆ í™•ë¥ ì„ í¼ì£¼ê³ , ë‹¤ë¥¸ ê¸°ê°„ì— ì´ë¥¼ íšŒìˆ˜í•˜ëŠ” 'í• ë‹¹ëŸ‰ ë³´ì¡´ ë²•ì¹™'ì„ êµì°¨ ë¶„ì„í•©ë‹ˆë‹¤.
                    </p>

                    <div class="controls"
                        style="background: rgba(187, 134, 252, 0.05); border-color: rgba(187, 134, 252, 0.2); margin-bottom: 25px;">
                        <div class="control-group" style="width: 100%;">
                            <label style="display:flex; justify-content:space-between;">
                                <span>ì‹œì¦Œ ë¶„í•  ì‹œì  (Split Point)</span>
                                <b id="splitDateLabel" style="color:var(--accent)">ë‚ ì§œ ë¡œë”© ì¤‘...</b>
                            </label>
                            <input type="range" id="splitSlider" style="width:100%; margin: 10px 0;">
                            <div style="display:flex; justify-content:space-between; font-size:0.75em; color:#666;">
                                <span id="sliderMinDate">--</span>
                                <span id="sliderMaxDate">--</span>
                            </div>
                        </div>
                    </div>

                    <div class="season-grid" id="seasonGrid">
                        <!-- Season cards here -->
                    </div>

                    <div class="chart-card full">
                        <div class="chart-title">âš–ï¸ ì‹œì¦Œë³„ ëˆ„ì  ì˜¤ì°¨ ë° ë©”ì†Œ ì†ì‹¤ì•¡ ì¶”ì´</div>
                        <canvas id="debtChart"></canvas>
                    </div>
                </div>
            </div>

            <script>
                const API = '/api/audit';
                const state = {
                    meta: {},
                    data: [],
                    sort: { key: 'abs_succ_z', asc: true },
                    charts: {},
                    drift: [],
                    heatmap: [],
                    monthly: [],
                    seasonContrast: null,
                    eventDec: { star_groups: {}, events: [] },
                    eventComp: { events: [], no_event: {} }
                };

                const ui = {
                    switchTab(tabId) {
                        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        event.target.classList.add('active');
                        document.getElementById(tabId + 'Section').classList.add('active');
                        if (tabId === 'seasonal') {
                            this.initSlider();
                            render.seasonalContrast();
                        }
                    },
                    initSlider() {
                        const slider = document.getElementById('splitSlider');
                        if (slider.max > 0 && slider.max != 100) return;

                        const dates = state.meta.dates;
                        if (!dates || dates.length === 0) return;

                        slider.min = 0;
                        slider.max = dates.length - 1;
                        slider.value = Math.floor(dates.length * 0.7);

                        // Simple Formatter
                        const fmt = (d) => d.length === 8 ? `${d.slice(0, 4)}-${d.slice(4, 6)}-${d.slice(6, 8)}` : d;

                        document.getElementById('sliderMinDate').textContent = fmt(dates[0]);
                        document.getElementById('sliderMaxDate').textContent = fmt(dates[dates.length - 1]);

                        const updateLabel = (val) => {
                            const date = dates[val];
                            document.getElementById('splitDateLabel').textContent = fmt(date);
                            return date;
                        };

                        slider.oninput = (e) => {
                            const date = updateLabel(e.target.value);
                            this.updateSeasonal(date);
                        };

                        const initialDate = updateLabel(slider.value);
                        this.updateSeasonal(initialDate);
                    },
                    async updateSeasonal(date) {
                        clearTimeout(this.splitTimer);
                        this.splitTimer = setTimeout(async () => {
                            const res = await fetch(`${API}/season-contrast?split_date=${date}`);
                            state.seasonContrast = await res.json();
                            render.seasonalContrast();
                        }, 100);
                    }
                };



                const filters = {
                    async init() {
                        const res = await fetch(`${API}/meta`);
                        state.meta = await res.json();

                        const container = document.getElementById('eventCheckboxes');
                        state.meta.events.forEach(e => {
                            const lbl = document.createElement('label');
                            lbl.innerHTML = `<input type="checkbox" value="${e}" checked> ${e}`;
                            container.appendChild(lbl);
                        });

                        document.querySelectorAll('#statsTable th[data-key]').forEach(th => {
                            th.addEventListener('click', () => {
                                const key = th.dataset.key;
                                state.sort = { key, asc: state.sort.key === key ? !state.sort.asc : true };
                                render.table();
                            });
                        });

                        this.apply();
                    },

                    async apply() {
                        const checkboxes = document.querySelectorAll('#eventCheckboxes input:checked');
                        const selectedEvents = Array.from(checkboxes).map(cb => cb.value);
                        const starMin = parseInt(document.getElementById('starMin').value) || 0;
                        const starMax = parseInt(document.getElementById('starMax').value) || 29;
                        const stars = []; for (let i = starMin; i <= starMax; i++) stars.push(i);

                        const payload = {
                            events: selectedEvents,
                            stars: stars,
                            catch_ops: document.getElementById('catchFilter').value ? [document.getElementById('catchFilter').value] : [],
                            min_samples: parseInt(document.getElementById('minSamples').value)
                        };

                        const [queryRes, driftRes, heatmapRes, monthlyRes, eventCompRes, eventDecRes, eventDatesRes, seasonRes] = await Promise.all([
                            fetch(`${API}/query`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }),
                            fetch(`${API}/drift`),
                            fetch(`${API}/heatmap`),
                            fetch(`${API}/monthly`),
                            fetch(`${API}/event-comparison`),
                            fetch(`${API}/event-deception`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }),
                            fetch(`${API}/event-dates`),
                            fetch(`${API}/season-contrast`)
                        ]);

                        const queryData = await queryRes.json();
                        state.drift = (await driftRes.json()).drift;
                        state.heatmap = await heatmapRes.json();
                        state.monthly = (await monthlyRes.json()).monthly;
                        state.eventComp = await eventCompRes.json();
                        state.eventDec = await eventDecRes.json();
                        state.eventDates = (await eventDatesRes.json()).dates;
                        state.seasonContrast = await seasonRes.json();

                        state.data = queryData.results.map(r => ({
                            ...r,
                            abs_succ_z: Math.abs(r.succ_z),
                            precision: r.succ_p_val < 0.01 ? 'CRITICAL' : (r.succ_p_val < 0.05 ? 'HIGH' : 'NORMAL')
                        }));

                        render.all();
                    }
                };

                const render = {
                    all() {
                        this.summary();
                        this.eventAnalysis();
                        this.auditCards();
                        this.table();
                        this.charts();
                        this.heatmap();
                        this.hypothesis();
                        if (document.getElementById('seasonalSection').classList.contains('active')) {
                            this.seasonalContrast();
                        }
                    },

                    seasonalContrast() {
                        const sc = state.seasonContrast;
                        if (!sc) return;

                        const grid = document.getElementById('seasonGrid');

                        const costFactor = sc.cost_factor || 0.4;
                        const createCard = (key, data, label) => {
                            const isPositive = data.error_count > 0;
                            const sign = isPositive ? '+' : '';
                            const color = isPositive ? 'var(--success)' : 'var(--danger)';
                            const mesoSign = isPositive ? 'ì´ë“ (Gain)' : 'ì†ì‹¤ (Loss)';
                            const mesoVal = (data.error_count * costFactor).toFixed(1);

                            return `
                                <div class="season-card ${key}">
                                    <span class="season-tag" style="color:#aaa">${label}</span>
                                    <div class="season-desc">Start ~ End êµ¬ê°„ ì„±ê³µ ì˜¤ì°¨</div>
                                    <div class="season-value" style="color:${color}">${sign}${data.error_count.toLocaleString()}íšŒ</div>
                                    <div class="season-desc">${isPositive ? 'ê¸°ëŒ€ë³´ë‹¤ ë” ë§ì´ ì„±ê³µí•¨' : 'ê¸°ëŒ€ë³´ë‹¤ ëœ ì„±ê³µí•¨ (ì–µì œë¨)'}</div>
                                    <div class="meso-value" style="color:${color}">ğŸ’° ì•½ ${Math.abs(mesoVal)}ì–µ ë©”ì†Œ ${mesoSign}</div>
                                </div>
                            `;
                        };

                        grid.innerHTML =
                            createCard('before', sc.before, sc.before.period) +
                            createCard('after', sc.after, sc.after.period);
                    },

                    eventAnalysis() {
                        const dec = state.eventDec;
                        if (!dec) return;

                        // 1. Global Index
                        const dVal = document.getElementById('deceptionIndex');
                        if (dec.insufficient_data) {
                            dVal.textContent = 'N/A';
                            dVal.style.color = '#888';
                            document.getElementById('deceptionDesc').textContent = 'ë°ì´í„° ë¶€ì¡± (ë¶„ì„ ë¶ˆê°€)';
                        } else {
                            dVal.textContent = dec.deception_index.toFixed(2);
                            dVal.style.color = dec.deception_index > 0.5 ? '#cf6679' : '#03dac6';
                            document.getElementById('deceptionDesc').textContent = dec.interpretation;
                        }

                        // 2. Star Groups
                        const groupHtml = Object.entries(dec.star_groups).map(([name, data]) => {
                            if (data.insufficient_data) {
                                return `
                                    <div style="margin-bottom:12px; border-bottom:1px solid #333; padding-bottom:8px;">
                                        <div style="font-weight:bold; color:#e0e0e0; margin-bottom:4px;">${name}</div>
                                        <div style="font-size:0.9em; color:#666;">âš ï¸ ë°ì´í„° ë¶€ì¡±</div>
                                    </div>
                                `;
                            }
                            const color = data.deception > 1.0 ? '#cf6679' : (data.deception > 0 ? '#ffb74d' : '#03dac6');
                            const varColor = data.var_suppression > 1.5 ? '#cf6679' : (data.var_suppression > 1.1 ? '#ffb74d' : '#888');

                            return `
                                <div style="margin-bottom:12px; border-bottom:1px solid #333; padding-bottom:8px;">
                                    <div style="font-weight:bold; color:#e0e0e0; margin-bottom:4px;">${name}</div>
                                    <div style="display:flex; justify-content:space-between; font-size:0.9em;">
                                        <span>ê¸°ë§ ì§€ìˆ˜ (ì„±ê³µ ì–µì œ): <b style="color:${color}">${data.deception > 0 ? '+' : ''}${data.deception}%</b></span>
                                        <span>VAR ì–µì œ: <b style="color:${varColor}">x ${data.var_suppression.toFixed(2)}</b></span>
                                    </div>
                                </div>
                            `;
                        }).join('');
                        document.getElementById('starGroupContainer').innerHTML = groupHtml;

                        // 3. Event Ranking
                        const rankBody = document.getElementById('eventRankBody');
                        if (!dec.events || dec.events.length === 0) {
                            rankBody.innerHTML = '<tr><td colspan="3">ë¶„ì„ ê°€ëŠ¥í•œ ì´ë²¤íŠ¸ ì—†ìŒ</td></tr>';
                        } else {
                            rankBody.innerHTML = dec.events.map(e => {
                                const color = e.deception > 1.0 ? '#cf6679' : (e.deception > 0 ? '#ffb74d' : '#888');
                                return `
                                    <tr>
                                        <td style="font-size:0.85em; max-width:150px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${e.name}">${e.name}</td>
                                        <td style="color:${color}; font-weight:bold;">${e.deception > 0 ? '+' : ''}${e.deception}%</td>
                                        <td style="color:${e.var_suppression > 1.2 ? '#cf6679' : '#888'}">x ${e.var_suppression.toFixed(2)}</td>
                                    </tr>
                                `;
                            }).join('');
                        }
                    },

                    summary() {
                        let totalWeight = 0, weightedSum = 0;
                        state.data.forEach(r => {
                            const weight = Math.log10(r.total_n + 1);
                            // Score based on p-value (rareness)
                            const score = Math.min(1, r.succ_p_val * 10);
                            weightedSum += score * weight;
                            totalWeight += weight;
                        });
                        const integrityPct = totalWeight > 0 ? Math.round((weightedSum / totalWeight) * 100) : 0;

                        document.getElementById('integrityScore').textContent = integrityPct + '%';
                        const bar = document.getElementById('integrityBar');
                        bar.style.width = integrityPct + '%';

                        let label, color;
                        if (integrityPct < 15) { label = 'ğŸ”´ í¬ê·€ì„± ì„ê³„ê°’ ë„ë‹¬ - ì¡°ì‘ í™•ì •ì '; color = '#cf6679'; }
                        else if (integrityPct < 50) { label = 'ğŸŸ  í†µê³„ì  ì´ìƒ ìƒíƒœ - ì •ë°€ ê´€ë¦¬ ì˜ì‹¬'; color = '#ffb74d'; }
                        else { label = 'ğŸŸ¢ ìì—°ì  ëœë¤ ë¶„í¬'; color = '#03dac6'; }
                        document.getElementById('integrityLabel').textContent = label;
                        bar.style.background = color;

                        const guns = [...state.data].filter(r => r.total_n > 100000).sort((a, b) => a.succ_p_val - b.succ_p_val).slice(0, 3);
                        document.getElementById('smokingGunList').innerHTML = guns.map(r => `
                            <div class="gun-item">
                                <div><span class="star">${r.star}ì„± ${r.catch}</span> <span class="stats">| N=${r.total_n.toLocaleString()} | p=${r.succ_p_val.toExponential(2)} | VAR Ratio=${r.succ_var_ratio.toFixed(2)}</span></div>
                                <span class="verdict">${r.succ_p_val < 0.001 ? 'ğŸš¨ ì ˆëŒ€ ì‹ ë¢° ë¶ˆê°€' : 'âš ï¸ ìœ ì˜ë¯¸í•œ ì´ìƒ'}</span>
                            </div>
                        `).join('') || '<div class="gun-item">í•´ë‹¹ êµ¬ê°„ ì—†ìŒ</div>';
                    },

                    auditCards() {
                        const precisionCount = state.data.filter(r => r.succ_p_val < 0.01).length;
                        document.getElementById('precisionMetric').innerHTML = `<span style="color:${precisionCount > 0 ? '#cf6679' : '#03dac6'}">${precisionCount}ê°œ</span>`;

                        const thresholdCount = state.data.filter(r => r.succ_z < -2 && r.boom_z < -2).length;
                        document.getElementById('thresholdMetric').innerHTML = `<span style="color:${thresholdCount > 0 ? '#ffb74d' : '#03dac6'}">${thresholdCount}ê°œ</span>`;

                        const lastDrift = state.drift.length > 0 ? state.drift[state.drift.length - 1] : null;
                        const zerosumScore = lastDrift ? Math.abs(lastDrift.cumulative_succ_z).toFixed(1) : '--';
                        document.getElementById('zerosumMetric').innerHTML = `<span style="color:${parseFloat(zerosumScore) < 5 ? '#cf6679' : '#03dac6'}">Î£=${zerosumScore}</span>`;
                    },

                    table() {
                        const tbody = document.querySelector('#statsTable tbody');
                        tbody.innerHTML = '';

                        document.querySelectorAll('#statsTable th').forEach(th => {
                            th.classList.remove('sorted-asc', 'sorted-desc');
                            if (th.dataset.key === state.sort.key) th.classList.add(state.sort.asc ? 'sorted-asc' : 'sorted-desc');
                        });

                        const sorted = [...state.data].sort((a, b) => {
                            let va = a[state.sort.key], vb = b[state.sort.key];
                            if (typeof va === 'string') return state.sort.asc ? va.localeCompare(vb) : vb.localeCompare(va);
                            return state.sort.asc ? va - vb : vb - va;
                        });

                        sorted.forEach(row => {
                            const tr = document.createElement('tr');
                            if (row.precision === 'CRITICAL') tr.classList.add('row-critical');
                            else if (row.precision === 'HIGH') tr.classList.add('row-managed');

                            const getVerdict = r => {
                                if (r.precision === 'CRITICAL') return 'ğŸ”´ ì¡°ì‘ í™•ì •';
                                if (r.precision === 'HIGH') return 'ğŸŸ  ì¡°ì‘ ì˜ì‹¬';
                                if (r.succ_var_ratio < 0.5) return 'âš ï¸ í‰íƒ„í™”';
                                if (r.succ_var_ratio > 1.5) return 'ğŸ“ˆ ë¶ˆê·œì¹™';
                                return 'ğŸŸ¢ ì •ìƒ';
                            };

                            tr.innerHTML = `
                                <td>${row.star}</td>
                                <td><span class="badge ${row.catch === 'ON' ? 'badge-on' : 'badge-off'}">${row.catch}</span></td>
                                <td>${row.total_n.toLocaleString()}</td>
                                <td class="tooltip" data-tip="p-value=${row.succ_p_val.toExponential(3)} (N=${row.total_n.toLocaleString()}ì—ì„œ ì´ ì˜¤ì°¨ëŠ” ìì—°ì ì¼ ìˆ˜ ì—†ìŒ)">${row.succ_z.toFixed(2)}</td>
                                <td style="color:${row.succ_var_ratio < 0.5 ? '#cf6679' : (row.succ_var_ratio > 1.5 ? '#ffb74d' : '#03dac6')}">${row.succ_var_ratio.toFixed(2)}</td>
                                <td style="color:${row.boom_z < -2 ? '#ffb74d' : '#888'}">${row.boom_z.toFixed(2)}</td>
                                <td><span class="badge ${row.precision === 'CRITICAL' ? 'badge-danger' : row.precision === 'HIGH' ? 'badge-warning' : ''}">${row.precision}</span></td>
                                <td>${getVerdict(row)}</td>
                            `;
                            tbody.appendChild(tr);
                        });
                    },

                    charts() {
                        const ctxT = document.getElementById('thresholdChart').getContext('2d');
                        if (state.charts.threshold) state.charts.threshold.destroy();

                        const thresholdPts = state.data.map(r => ({ x: r.succ_z, y: r.boom_z, label: `${r.star}* ${r.catch}` }));
                        state.charts.threshold = new Chart(ctxT, {
                            type: 'scatter',
                            data: {
                                datasets: [{
                                    label: 'ì„±ê³µ Z vs íŒŒê´´ Z',
                                    data: thresholdPts,
                                    backgroundColor: thresholdPts.map(p => (p.x < -2 && p.y < 0) ? '#cf6679' : '#03dac6'),
                                    pointRadius: 6
                                }]
                            },
                            options: {
                                responsive: true, maintainAspectRatio: false,
                                scales: {
                                    x: {
                                        title: { display: true, text: 'ì„±ê³µ Z (ìŒìˆ˜=ì–µì œ)' },
                                        grid: {
                                            color: (ctx) => ctx.tick.value === 0 ? 'rgba(255, 255, 255, 0.5)' : 'rgba(255, 255, 255, 0.1)',
                                            lineWidth: (ctx) => ctx.tick.value === 0 ? 2 : 1
                                        }
                                    },
                                    y: {
                                        title: { display: true, text: 'íŒŒê´´ Z (ìŒìˆ˜=ì–µì œ)' },
                                        grid: {
                                            color: (ctx) => ctx.tick.value === 0 ? 'rgba(255, 255, 255, 0.5)' : 'rgba(255, 255, 255, 0.1)',
                                            lineWidth: (ctx) => ctx.tick.value === 0 ? 2 : 1
                                        }
                                    }
                                },
                                plugins: { tooltip: { callbacks: { label: ctx => `${ctx.raw.label}: ì„±ê³µZ=${ctx.raw.x.toFixed(2)}, íŒŒê´´Z=${ctx.raw.y.toFixed(2)}` } } }
                            }
                        });

                        const ctxD = document.getElementById('driftChart').getContext('2d');
                        if (state.charts.drift) state.charts.drift.destroy();

                        state.charts.drift = new Chart(ctxD, {
                            type: 'line',
                            data: {
                                labels: state.drift.map(d => d.date),
                                datasets: [
                                    { label: 'ëˆ„ì  ì„±ê³µ Z', data: state.drift.map(d => d.cumulative_succ_z), borderColor: '#bb86fc', yAxisID: 'y', fill: false, tension: 0.3 },
                                    { label: 'ëˆ„ì  ì„±ê³µ ì˜¤ì°¨ (íšŸìˆ˜)', data: state.drift.map(d => d.cumulative_error), borderColor: '#03dac6', yAxisID: 'y1', fill: true, backgroundColor: 'rgba(3, 218, 198, 0.05)', tension: 0.3 }
                                ]
                            },
                            options: {
                                responsive: true, maintainAspectRatio: false,
                                scales: {
                                    y: { title: { display: true, text: 'ëˆ„ì  Z (íšŒê·€ì„±)' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                                    y1: { position: 'right', title: { display: true, text: 'ëˆ„ì  ì˜¤ì°¨ (íšŒ)' }, grid: { display: false } }
                                },
                                plugins: {
                                    legend: { position: 'bottom' },
                                    annotation: {
                                        annotations: state.eventDates.filter(d => d.is_event_period).map(d => ({
                                            type: 'box',
                                            xMin: d.date,
                                            xMax: d.date,
                                            backgroundColor: 'rgba(187, 134, 252, 0.05)',
                                            borderWidth: 0,
                                            label: { content: 'EVENT', display: false }
                                        }))
                                    }
                                }
                            }
                        });


                        const ctxDebt = document.getElementById('debtChart').getContext('2d');
                        if (state.charts.debt) state.charts.debt.destroy();

                        state.charts.debt = new Chart(ctxDebt, {
                            type: 'line',
                            data: {
                                labels: state.drift.map(d => d.date),
                                datasets: [
                                    { label: 'ëˆ„ì  ë©”ì†Œ ì†ì‹¤ì•¡ (ì–µ)', data: state.drift.map(d => d.cumulative_meso / 100), borderColor: '#ffb74d', fill: true, backgroundColor: 'rgba(255, 183, 77, 0.1)', tension: 0.3 }
                                ]
                            },
                            options: {
                                responsive: true, maintainAspectRatio: false,
                                scales: { y: { title: { display: true, text: 'ë©”ì†Œ (ì–µ)' } } },
                                plugins: { annotation: { annotations: state.eventDates.filter(d => d.is_event_period).map(d => ({ type: 'box', xMin: d.date, xMax: d.date, backgroundColor: 'rgba(255,183,77,0.05)', borderWidth: 0 })) } }
                            }
                        });

                        const ctxM = document.getElementById('monthlyChart').getContext('2d');
                        if (state.charts.monthly) state.charts.monthly.destroy();

                        state.charts.monthly = new Chart(ctxM, {
                            type: 'bar',
                            data: {
                                labels: state.monthly.map(d => d.month),
                                datasets: [
                                    { label: 'ì„±ê³µ Z í•©ê³„', data: state.monthly.map(d => d.total_succ_z), backgroundColor: '#bb86fc' },
                                    { label: 'íŒŒê´´ Z í•©ê³„', data: state.monthly.map(d => d.total_boom_z), backgroundColor: '#cf6679' }
                                ]
                            },
                            options: {
                                responsive: true, maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        title: { display: true, text: 'Z-Score í•©ê³„' },
                                        grid: { color: (ctx) => ctx.tick.value === 0 ? 'rgba(255, 255, 255, 0.5)' : 'rgba(255, 255, 255, 0.1)', lineWidth: (ctx) => ctx.tick.value === 0 ? 2 : 1 }
                                    }
                                }
                            }
                        });

                        const ctxP = document.getElementById('precisionChart').getContext('2d');
                        if (state.charts.precision) state.charts.precision.destroy();

                        const precisionPts = state.data.map(r => ({ x: Math.log10(r.total_n), y: r.abs_succ_z, label: `${r.star}* ${r.catch}` }));
                        state.charts.precision = new Chart(ctxP, {
                            type: 'scatter',
                            data: {
                                datasets: [{
                                    data: precisionPts,
                                    backgroundColor: precisionPts.map(p => (p.y < 0.5 && p.x > 6) ? '#cf6679' : '#03dac6'),
                                    pointRadius: 6
                                }]
                            },
                            options: {
                                responsive: true, maintainAspectRatio: false,
                                scales: {
                                    x: { title: { display: true, text: 'logâ‚â‚€(N) - í‘œë³¸ í¬ê¸°' } },
                                    y: { title: { display: true, text: '|Z| - ì‘ì„ìˆ˜ë¡ ì •ë°€ ê´€ë¦¬' }, min: 0 }
                                },
                                plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => `${ctx.raw.label}: N=10^${ctx.raw.x.toFixed(1)}, |Z|=${ctx.raw.y.toFixed(3)}` } } }
                            }
                        });

                        const ctxH = document.getElementById('histChart').getContext('2d');
                        if (state.charts.hist) state.charts.hist.destroy();

                        const zVals = state.data.map(r => r.succ_z);
                        const bins = [[-3, -2], [-2, -1], [-1, -0.5], [-0.5, 0], [0, 0.5], [0.5, 1], [1, 2], [2, 3]];
                        const counts = bins.map(([min, max]) => zVals.filter(z => z >= min && z < max).length);

                        state.charts.hist = new Chart(ctxH, {
                            type: 'bar',
                            data: {
                                labels: bins.map(([a, b]) => `${a}~${b}`),
                                datasets: [{ data: counts, backgroundColor: counts.map((_, i) => (i === 3 || i === 4) ? '#cf6679' : '#03dac6') }]
                            },
                            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                        });
                    },

                    heatmap() {
                        const { data, dates, stars } = state.heatmap;
                        if (!dates || !stars || dates.length === 0) {
                            document.getElementById('heatmapArea').innerHTML = 'íˆíŠ¸ë§µ ë°ì´í„° ì—†ìŒ';
                            return;
                        }

                        // Event Lookup Map
                        const eventMap = {};
                        if (state.eventDates) {
                            state.eventDates.forEach(e => {
                                eventMap[e.date] = e.events.join(', ');
                            });
                        }

                        const relevantStars = stars.filter(s => s >= 12 && s <= 25);

                        let html = '<table class="heatmap-table">';
                        html += '<tr><th style="padding:5px;"></th>';
                        dates.forEach(d => html += `<th class="heatmap-header" title="${eventMap[d] || ''}">${d.slice(4, 6)}/${d.slice(6, 8)}</th>`);
                        html += '</tr>';

                        relevantStars.forEach(star => {
                            html += `<tr><td class="heatmap-label">${star}â˜…</td>`;
                            dates.forEach(date => {
                                const cell = data.find(d => d.star === star && d.date === date);
                                const eventName = eventMap[date] || 'ì´ë²¤íŠ¸ ì •ë³´ ì—†ìŒ';

                                if (cell) {
                                    const z = cell.succ_z;
                                    const absZ = Math.abs(z);
                                    let color;
                                    if (absZ < 1.0) color = `rgba(3,218,198,${0.1 + (1 - absZ) * 0.3})`; // Greenish for normal
                                    else if (absZ < 2.0) color = `rgba(255,183,77,${(absZ - 1.0) * 0.5 + 0.2})`; // Orange for warning
                                    else color = `rgba(207,102,121,${Math.min(0.9, (absZ - 2.0) * 0.2 + 0.5)})`; // Red for outlier

                                    html += `<td><div class="heatmap-cell" style="background:${color};" 
                                        title="[${date}] ${eventName}\n${star}ì„±: Z=${z.toFixed(2)} (N=${cell.total_n.toLocaleString()})">${z.toFixed(1)}</div></td>`;
                                } else {
                                    html += `<td><div class="heatmap-cell" style="background:#222;" title="[${date}] ${eventName}\në°ì´í„° ì—†ìŒ">-</div></td>`;
                                }
                            });
                            html += '</tr>';
                        });
                        html += '</table>';
                        document.getElementById('heatmapArea').innerHTML = html;
                    },

                    hypothesis() {
                        const smoothedHigh = state.data.filter(r => r.succ_var_ratio < 0.5 && r.total_n > 100000).length;
                        const totalHigh = state.data.filter(r => r.total_n > 100000).length;
                        const ratio = totalHigh > 0 ? smoothedHigh / totalHigh : 0;

                        const lastDrift = state.drift.length > 0 ? state.drift[state.drift.length - 1] : null;
                        const driftScore = lastDrift ? Math.abs(lastDrift.cumulative_succ_z) : 999;

                        let verdict;
                        if (ratio > 0.3 && driftScore < 10) {
                            verdict = `<span style="color:#cf6679">ğŸš¨ <b>ê°•ë ¥í•œ ì¦ê±°</b>: ${(ratio * 100).toFixed(0)}%ì˜ ê³ í‘œë³¸ êµ¬ê°„ì´ ê³¼ì†Œì‚°í¬(VAR Ratio < 0.5)ë¥¼ ë³´ì´ë©°, ëˆ„ì  Zê°€ ${driftScore.toFixed(1)}ë¡œ 0ì— ìˆ˜ë ´í•©ë‹ˆë‹¤. ì´ëŠ” <b>ë…ë¦½ ì‹œí–‰ì´ ì•„ë‹Œ í• ë‹¹ëŸ‰ ê¸°ë°˜ ì‹œìŠ¤í…œ</b>ì˜ ì „í˜•ì ì¸ íŠ¹ì§•ì…ë‹ˆë‹¤.</span>`;
                        } else if (ratio > 0.15 || driftScore < 20) {
                            verdict = `<span style="color:#ffb74d">âš ï¸ <b>ì˜ì‹¬</b>: ì¼ë¶€ êµ¬ê°„(${(ratio * 100).toFixed(0)}%)ì—ì„œ í‰íƒ„í™” ì§•í›„ê°€ ìˆìœ¼ë©°, ë“œë¦¬í”„íŠ¸ ê°’(${driftScore.toFixed(1)})ì´ ë‚®ìŠµë‹ˆë‹¤.</span>`;
                        } else {
                            verdict = `<span style="color:#03dac6">âœ… <b>ë…ë¦½ ì‹œí–‰ ì¼ì¹˜</b>: ë¶„ì‚° ë¹„ìœ¨ê³¼ ë“œë¦¬í”„íŠ¸ê°€ ìì—°ì  ë²”ìœ„ ë‚´ì— ìˆìŠµë‹ˆë‹¤.</span>`;
                        }
                        document.getElementById('hypothesisResult').innerHTML = verdict;
                    }
                };

                document.addEventListener('DOMContentLoaded', () => filters.init());
            </script>
</body>

</html>